<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Personal Hub | Premium Organizer</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --p: #7c4dff;
            --p-light: #b388ff;
            --s: #448aff;
            --bg: #050510;
            --glass: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            background-image:
                radial-gradient(at 0% 0%, rgba(124, 77, 255, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(68, 138, 255, 0.15) 0px, transparent 50%),
                radial-gradient(at 50% 100%, rgba(124, 77, 255, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.5rem 1.5rem 100px 1.5rem;
            width: 100%;
            flex: 1;
        }

        /* Nav */
        .nav-bar {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            right: 1.5rem;
            z-index: 2000;
            display: flex;
            justify-content: space-around;
            padding: 0.8rem;
            height: 72px;
            align-items: center;
        }

        @media (min-width: 768px) {
            .nav-bar {
                top: 1.5rem;
                bottom: auto;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                width: fit-content;
                gap: 1rem;
                padding: 0.5rem 2rem;
            }

            .container {
                padding-top: 100px;
                padding-bottom: 2rem;
            }
        }

        .btn-tab {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 0.8rem;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .btn-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-tab i,
        .btn-tab svg {
            width: 24px;
            height: 24px;
            pointer-events: none;
        }

        button i,
        button svg {
            pointer-events: none;
        }

        /* Auth UI */
        #auth-overlay {
            position: fixed;
            inset: 0;
            z-index: 3000;
            background: rgba(5, 5, 16, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            text-align: center;
        }

        .auth-input {
            margin-bottom: 1rem;
            text-align: left;
        }

        .btn-primary {
            width: 100%;
            background: var(--p);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 16px;
            font-weight: 800;
            cursor: pointer;
            margin-top: 1rem;
            box-shadow: 0 8px 20px rgba(124, 77, 255, 0.3);
        }

        /* Calendar */
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            font-weight: 700;
            font-size: 0.9rem;
            position: relative;
            background: rgba(255, 255, 255, 0.02);
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .day-cell.active {
            background: var(--p);
            color: white;
            box-shadow: 0 4px 15px rgba(124, 77, 255, 0.4);
        }

        .day-cell.today {
            border-color: var(--p);
        }

        .dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
        }

        .dot.t {
            background: #00e676;
            left: calc(50% - 3px);
        }

        .dot.h {
            background: var(--p-light);
            left: calc(50% + 3px);
        }

        /* Generic */
        .block-card {
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .habit-item {
            padding: 1.2rem;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .chk {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 2px solid var(--p);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chk.on {
            background: var(--p);
            color: white;
        }

        .ex-card {
            padding: 1.2rem;
            margin-bottom: 1rem;
        }

        .ex-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-weight: 700;
        }

        #toast {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            background: #00e676;
            color: #000;
            font-weight: 800;
            z-index: 4000;
            opacity: 0;
            transition: 0.3s;
        }

        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div id="toast">Sincronizado</div>

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay">
        <div class="glass auth-card fade-in">
            <h1 style="margin-bottom: 0.5rem;">Hola Aaron</h1>
            <p style="color: var(--text-dim); margin-bottom: 2rem;">Accede a tu cuenta personal</p>

            <div class="auth-input">
                <input type="email" id="auth-email" placeholder="Email">
            </div>
            <div class="auth-input">
                <input type="password" id="auth-pass" placeholder="Contrase√±a">
            </div>

            <button class="btn-primary" id="btn-login" onclick="window.handleAuth('login')">Entrar</button>
            <button
                style="background:none; border:none; color:var(--text-dim); margin-top:1.5rem; font-weight:700; cursor:pointer;"
                onclick="window.handleAuth('signup')">Crear cuenta</button>
        </div>
    </div>

    <!-- MAIN APP (HIDDEN UNTIL AUTH) -->
    <div id="app-view" class="hidden">
        <nav class="nav-bar glass">
            <button class="btn-tab active" onclick="window.setTab('diary', this)"><i
                    data-lucide="calendar"></i>Diario</button>
            <button class="btn-tab" onclick="window.setTab('training', this)"><i
                    data-lucide="dumbbell"></i>Entreno</button>
            <button class="btn-tab" onclick="window.setTab('stats', this)"><i
                    data-lucide="trending-up"></i>Stats</button>
            <button class="btn-tab" onclick="window.setTab('finance', this)"><i
                    data-lucide="wallet"></i>Capital</button>
            <button class="btn-tab" onclick="window.logout()"><i data-lucide="log-out"></i></button>
        </nav>

        <div class="container">
            <section id="view-diary" class="tab-content fade-in">
                <h1>Hola de nuevo Aaron</h1>
                <p class="section-desc">Gestiona tus rachas y h√°bitos de hoy.</p>

                <div class="glass cal-card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <button class="btn-tab" onclick="window.calShift(-1)" style="padding: 4px;"><i
                                data-lucide="chevron-left"></i></button>
                        <h3 id="calTitle" style="font-weight: 800;"></h3>
                        <button class="btn-tab" onclick="window.calShift(1)" style="padding: 4px;"><i
                                data-lucide="chevron-right"></i></button>
                    </div>
                    <div class="cal-grid" id="calGrid"></div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0 1rem;">
                    <h2 id="diaryHeading">H√°bitos de Hoy</h2>
                    <button onclick="window.addHabit()"
                        style="background:none; border:none; color:var(--p); font-weight:800;">+ A√±adir</button>
                </div>
                <div id="habitsCont"></div>
            </section>

            <section id="view-training" class="tab-content hidden">
                <div id="tn-list" class="fade-in">
                    <h1>Entrenamientos</h1>
                    <p class="section-desc">Selecciona tu rutina para hoy.</p>
                    <div id="blocksCont" class="block-grid"></div>
                    <button class="btn-primary" onclick="window.addBlock()" style="width: 100%;">+ Nuevo Bloque</button>
                </div>

                <div id="tn-detail" class="hidden fade-in">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <button onclick="window.showBlocks()" style="background:none; border:none; color:white;"><i
                                data-lucide="arrow-left"></i></button>
                        <h1 id="blockTitle" style="margin:0; font-size: 1.8rem;"></h1>
                    </div>
                    <button id="btnDone" onclick="window.markDayTrained()" class="glass"
                        style="width: 100%; padding: 1.2rem; margin-bottom: 2rem; color: var(--p); font-weight: 800; cursor: pointer;">
                        Marcar sesi√≥n completada
                    </button>
                    <div id="exsCont"></div>
                    <button onclick="window.addEx()" class="glass"
                        style="width:100%; padding: 1rem; border-style: dashed; color: var(--text-dim);">+ A√±adir
                        Ejercicio</button>
                </div>
            </section>

            <section id="view-finance" class="tab-content hidden">
                <h1>Finanzas</h1>
                <p class="section-desc">Gestiona tus ingresos, gastos fijos y reparto del capital.</p>

                <div class="glass" style="padding: 2rem; text-align: center; margin-bottom: 2rem;">
                    <div style="width: 200px; height: 200px; margin: 0 auto 1.5rem;"><canvas id="finChart"></canvas>
                    </div>
                    <p style="text-transform:uppercase; font-size:0.7rem; font-weight:800; color:var(--text-dim);">
                        Sobrante tras gastos</p>
                    <h2 id="totalIncDisp" style="font-size: 3rem; font-weight: 800;">2000‚Ç¨</h2>
                    <div style="display:flex; justify-content:center; gap:10px; align-items:center;">
                        <span style="font-size:0.9rem; font-weight:700;">Sueldo:</span>
                        <input type="number" id="incInput" onchange="window.saveFinConfig()"
                            style="text-align: center; max-width: 120px;" value="2000">
                    </div>
                </div>

                <!-- Reparto Percentiles -->
                <div class="glass" style="padding:1.5rem; margin-bottom:2rem;">
                    <h3 style="margin-bottom:1rem; font-size:1rem;">Configurar Reparto (%)</h3>
                    <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:1rem;" id="pctInputs">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <div id="finDetails"></div>

                <div style="display:grid; grid-template-columns: 1fr; gap:1.5rem; margin-top:2rem;">
                    <!-- Gastos Fijos -->
                    <div class="glass" style="padding:1.5rem;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                            <h3 style="font-size:1rem;">Gastos Fijos Mensuales</h3>
                            <button onclick="window.addFinItem('fixed')"
                                style="background:none; border:none; color:var(--p); font-weight:800;">+ A√±adir</button>
                        </div>
                        <div id="fixedList"></div>
                    </div>

                    <!-- Bloc Extras -->
                    <div class="glass" style="padding:1.5rem;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                            <h3 style="font-size:1rem;">Bloc Pagos Extras</h3>
                            <button onclick="window.addFinItem('extras')"
                                style="background:none; border:none; color:var(--p); font-weight:800;">+ A√±adir</button>
                        </div>
                        <div id="extrasList"></div>
                    </div>
                </div>
            </section>

            <section id="view-stats" class="tab-content hidden">
                <h1>Estad√≠sticas Mensuales</h1>
                <p class="section-desc">Tu rendimiento en el mes de <span id="statsMonthLabel"
                        style="color:var(--p); font-weight:800;"></span></p>

                <div id="statsCont" style="display: grid; gap: 1rem; margin-top: 1rem;">
                    <!-- Stats cards injected here -->
                </div>
            </section>
        </div>

        <footer id="debug-footer" class="glass"
            style="margin-top:2rem; padding:1rem; font-size:0.7rem; color:var(--text-dim); display:none; flex-direction:column; gap:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <p style="margin:0;">üë§ <span id="debug-email"></span></p>
                    <p style="margin:0; opacity:0.5;">ID: <span id="debug-uid"></span></p>
                </div>
            </div>
            <p id="debug-sync-time" style="margin:0; text-align:right; opacity:0.5;">Sesi√≥n iniciada</p>
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SB_URL = 'https://qtekshafyvmvhyavcefk.supabase.co'
        const SB_KEY = 'sb_publishable_4iJQFm6hZEcvOyF8Igj1WA_8534gerH'
        const supabase = createClient(SB_URL, SB_KEY)
        window.supabase = supabase; // Global para debug

        // --- GLOBAL ERROR HANDLER ---
        window.onerror = (msg, url, line) => {
            console.error("Global Error:", msg, line);
            toast("Error Cr√≠tico: " + msg, "#ff4081");
        };

        // --- GLOBAL STATE ---
        let user = null;
        let isSyncing = false;
        let db = {
            habits: [],
            logs: {},
            blocks: [],
            t_logs: {},
            income: 2000,
            fin_config: {
                pcts: { spending: 60, savings: 20, invest: 10, leisure: 10 },
                fixed: [],
                extras: []
            }
        };

        let currCal = new Date();
        let selDayStr = new Date().toISOString().split('T')[0];
        let currBlockId = null;
        let finChartInstance = null;

        // --- UTILS ---
        const getEl = (id) => document.getElementById(id);
        const toast = (msg, color = '#00e676') => {
            const t = getEl('toast');
            if (!t) return;
            console.log("TOAST:", msg);
            t.innerText = msg;
            t.style.background = color;
            t.style.opacity = '1';
            setTimeout(() => { if (t) t.style.opacity = '0'; }, 3000);
        };

        // --- AUTH LOGIC ---
        window.handleAuth = async (type) => {
            try {
                const email = getEl('auth-email').value;
                const password = getEl('auth-pass').value;
                if (!email || !password) return alert('Introduce email y contrase√±a');

                toast(type === 'login' ? 'Identificando...' : 'Registrando...', '#448aff');
                const { data, error } = type === 'login'
                    ? await supabase.auth.signInWithPassword({ email, password })
                    : await supabase.auth.signUp({ email, password });

                if (error) throw error;
                toast("¬°Bienvenido!");
            } catch (e) {
                alert("Error de acceso: " + e.message);
                console.error(e);
            }
        }

        window.logout = async () => {
            console.log("Cerrando sesi√≥n...");
            await supabase.auth.signOut();
            localStorage.clear();
            sessionStorage.clear();
            window.location.reload();
        };

        // --- SYNC & DATA ---
        async function syncAll() {
            if (!user || isSyncing) return;
            isSyncing = true;
            try {
                console.log("Syncing user:", user.id);

                // Profiles (Income & Config)
                const { data: prof, error: profErr } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
                if (!profErr && prof) {
                    db.income = prof.income || 2000;
                    if (prof.fin_config) {
                        db.fin_config = prof.fin_config;
                        if (!db.fin_config.fixed) db.fin_config.fixed = [];
                        if (!db.fin_config.extras) db.fin_config.extras = [];
                        if (Array.isArray(db.fin_config.pcts)) {
                            const [sp, sa, iv, le] = db.fin_config.pcts;
                            db.fin_config.pcts = { spending: sp || 60, savings: sa || 20, invest: iv || 10, leisure: le || 10 };
                        }
                    }
                } else if (!profErr) {
                    await supabase.from('profiles').upsert({ id: user.id, income: 2000, fin_config: db.fin_config }, { onConflict: 'id' });
                }

                // Habits
                const { data: habs, error: habErr } = await supabase.from('habits').select('*').eq('user_id', user.id);
                if (!habErr) db.habits = habs || [];

                // Habit Logs
                const { data: hlogs, error: hlogErr } = await supabase.from('habit_logs').select('*').eq('user_id', user.id);
                if (!hlogErr) {
                    db.logs = {};
                    hlogs?.forEach(l => {
                        if (!db.logs[l.date]) db.logs[l.date] = {};
                        db.logs[l.date][l.habit_id] = l.completed;
                    });
                }

                // Training Blocks
                const { data: blks, error: blkErr } = await supabase.from('training_blocks').select('*').eq('user_id', user.id);
                if (!blkErr) db.blocks = blks || [];

                // Training Logs
                const { data: tlogs, error: tlogErr } = await supabase.from('training_logs').select('*').eq('user_id', user.id);
                if (!tlogErr) {
                    db.t_logs = {};
                    tlogs?.forEach(l => db.t_logs[l.date] = l.completed);
                }

                console.log("Sync done. Habits:", db.habits.length);
                window.renderAll();
                toast("Sincronizado");
            } catch (e) {
                console.error("Sync Error:", e);
                toast("Error al sincronizar", "#ff4081");
                window.renderAll();
            } finally {
                isSyncing = false;
            }
        }

        // --- RENDERERS ---
        window.renderAll = () => {
            try {
                window.renderCal();
                window.renderHabits();
                if (!getEl('view-training').classList.contains('hidden')) window.showBlocks();
                if (!getEl('view-finance').classList.contains('hidden')) window.renderFin();
                if (!getEl('view-stats').classList.contains('hidden')) window.renderStats();
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (e) { console.error("RenderAll error:", e); }
        }

        window.renderCal = () => {
            const grid = getEl('calGrid');
            const title = getEl('calTitle');
            if (!grid || !title) return;
            grid.innerHTML = '';
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            title.innerText = `${monthNames[currCal.getMonth()]} ${currCal.getFullYear()}`;
            ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(d => grid.innerHTML += `<div style="font-size:0.6rem; color:var(--text-dim); font-weight:800; text-align:center;">${d}</div>`);

            const m = currCal.getMonth(), y = currCal.getFullYear();
            const first = new Date(y, m, 1).getDay();
            const total = new Date(y, m + 1, 0).getDate();
            const offset = (first === 0 ? 6 : first - 1);
            for (let i = 0; i < offset; i++) grid.appendChild(document.createElement('div'));

            for (let i = 1; i <= total; i++) {
                const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'day-cell' + (ds === selDayStr ? ' active' : '');
                if (ds === new Date().toISOString().split('T')[0]) cell.classList.add('today');
                cell.innerText = i;
                cell.onclick = () => { selDayStr = ds; window.renderCal(); window.renderHabits(); };

                if (db.t_logs[ds]) cell.innerHTML += `<div class="dot t"></div>`;
                const dLog = db.logs[ds];
                if (dLog && db.habits.length > 0) {
                    const allDone = db.habits.every(h => dLog[h.id]);
                    if (allDone) cell.innerHTML += `<div class="dot h"></div>`;
                }
                grid.appendChild(cell);
            }
        }

        window.renderHabits = () => {
            const cont = getEl('habitsCont');
            const heading = getEl('diaryHeading');
            if (!cont || !heading) return;
            heading.innerText = selDayStr === new Date().toISOString().split('T')[0] ? 'H√°bitos de Hoy' : `H√°bitos (${selDayStr})`;
            cont.innerHTML = db.habits.length === 0 ? `<p style="color:var(--text-dim); text-align:center; padding:2rem;">Sin h√°bitos.</p>` : '';
            db.habits.forEach(h => {
                const done = db.logs[selDayStr]?.[h.id] || false;
                const div = document.createElement('div');
                div.className = 'glass habit-item';
                div.innerHTML = `
                    <div style="flex:1; display:flex; align-items:center; gap:12px;" onclick="window.toggleHabit('${h.id}', ${done})">
                        <span style="font-weight:700;">${h.name}</span>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button onclick="event.stopPropagation(); window.editHabit('${h.id}')" style="background:none; border:none; color:var(--text-dim); padding:4px;"><i data-lucide="edit-2" style="width:16px;"></i></button>
                        <button onclick="event.stopPropagation(); window.deleteHabit('${h.id}')" style="background:none; border:none; color:#ff4d6d; padding:4px;"><i data-lucide="trash-2" style="width:16px;"></i></button>
                        <div class="chk ${done ? 'on' : ''}" onclick="event.stopPropagation(); window.toggleHabit('${h.id}', ${done})">${done ? '<i data-lucide="check" style="width:16px;"></i>' : ''}</div>
                    </div>
                `;
                cont.appendChild(div);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.editHabit = async (id) => {
            const h = db.habits.find(x => x.id === id);
            if (!h) return;
            const newName = prompt('Nuevo nombre para el h√°bito:', h.name);
            if (!newName || newName === h.name) return;

            toast("Actualizando...", "#448aff");
            try {
                const { error } = await supabase.from('habits').update({ name: newName }).eq('id', id);
                if (error) throw error;
                h.name = newName;
                window.renderHabits();
                toast("Actualizado");
            } catch (e) {
                console.error("EditHabit Fail:", e);
                toast("Error al editar", "#ff4081");
            }
        }

        window.deleteHabit = async (id) => {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este h√°bito y todos sus registros?')) return;

            toast("Eliminando...", "#ff4d6d");
            try {
                // Delete logs first if there's no cascade
                await supabase.from('habit_logs').delete().eq('habit_id', id);
                const { error } = await supabase.from('habits').delete().eq('id', id);
                if (error) throw error;

                db.habits = db.habits.filter(x => x.id !== id);
                // Clean up logs in memory
                Object.keys(db.logs).forEach(date => {
                    delete db.logs[date][id];
                });

                window.renderHabits();
                window.renderCal();
                toast("Eliminado");
            } catch (e) {
                console.error("DeleteHabit Fail:", e);
                toast("Error al eliminar", "#ff4081");
            }
        }

        window.showBlocks = () => {
            getEl('tn-detail').classList.add('hidden');
            getEl('tn-list').classList.remove('hidden');
            const cont = getEl('blocksCont');
            if (!cont) return;
            cont.innerHTML = db.blocks.length === 0 ? `<p style="color:var(--text-dim); text-align:center; padding:2rem;">Sin rutinas.</p>` : '';
            db.blocks.forEach(b => {
                const div = document.createElement('div');
                div.className = 'glass block-card';
                div.style.position = 'relative';
                div.onclick = () => window.showDetail(b.id);
                div.innerHTML = `
                    <div style="flex:1;">
                        <h3 style="margin:0;">${b.name}</h3>
                        <span style="opacity:0.4; font-weight:700;">${b.exercises?.length || 0} ej.</span>
                    </div>
                    <button onclick="event.stopPropagation(); window.deleteBlock('${b.id}')" style="background:none; border:none; color:#ff4d6d; padding:8px; display:flex; align-items:center;">
                        <i data-lucide="trash-2" style="width:18px;"></i>
                    </button>
                `;
                cont.appendChild(div);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.deleteBlock = async (id) => {
            if (!confirm('¬øEliminar esta rutina?')) return;
            toast("Eliminando...", "#ff4d6d");
            try {
                const { error } = await supabase.from('training_blocks').delete().eq('id', id);
                if (error) throw error;
                db.blocks = db.blocks.filter(x => x.id !== id);
                window.showBlocks();
                toast("Eliminado");
            } catch (e) {
                console.error("DeleteBlock Fail:", e);
                toast("Error al eliminar", "#ff4081");
            }
        }

        window.showDetail = (id) => {
            currBlockId = id;
            const b = db.blocks.find(x => x.id === id);
            if (!b) return;
            getEl('tn-list').classList.add('hidden');
            getEl('tn-detail').classList.remove('hidden');
            getEl('blockTitle').innerText = b.name;
            window.updateBtnTrained();
            window.renderExs();
        }

        window.renderExs = () => {
            const b = db.blocks.find(x => x.id === currBlockId);
            const cont = getEl('exsCont');
            if (!b || !cont) return;
            cont.innerHTML = '';
            if (b.exercises) {
                b.exercises.forEach((e, i) => {
                    const div = document.createElement('div');
                    div.className = 'glass ex-card';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <input value="${e.n}" onchange="window.updEx(${i},'n',this.value)" placeholder="Ejercicio" style="background:none; border:none; padding:0; font-size:1.1rem; width:100%; font-weight:700; color:var(--text); outline:none;">
                            <button onclick="window.deleteEx(${i})" style="background:none; border:none; color:#ff4d6d; padding:4px;"><i data-lucide="x" style="width:16px;"></i></button>
                        </div>
                        <div class="ex-input-grid">
                            <input type="text" value="${e.w || ''}" onchange="window.updEx(${i},'w',this.value)" placeholder="Peso">
                            <input type="number" value="${e.s || ''}" onchange="window.updEx(${i},'s',this.value)" placeholder="S">
                            <input type="number" value="${e.r || ''}" onchange="window.updEx(${i},'r',this.value)" placeholder="R">
                        </div>
                    `;
                    cont.appendChild(div);
                });
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.deleteEx = async (idx) => {
            const b = db.blocks.find(x => x.id === currBlockId); if (!b) return;
            b.exercises.splice(idx, 1);
            await supabase.from('training_blocks').update({ exercises: b.exercises }).eq('id', b.id);
            window.renderExs();
            toast("Ejercicio eliminado");
        }

        window.updateBtnTrained = () => {
            const btn = getEl('btnDone');
            if (!btn) return;
            const done = db.t_logs[selDayStr] || false;
            btn.style.background = done ? 'rgba(0, 230, 118, 0.1)' : '';
            btn.style.borderColor = done ? '#00e676' : '';
            btn.innerHTML = done ? '¬°Sesi√≥n registrada hoy!' : 'Marcar sesi√≥n completada';
        }

        window.renderFin = () => {
            if (!getEl('totalIncDisp')) return;

            const fixedSum = db.fin_config.fixed.reduce((a, b) => a + (Number(b.amount) || 0), 0);
            const extraSum = db.fin_config.extras.reduce((a, b) => a + (Number(b.amount) || 0), 0);
            const netIncome = Math.max(0, db.income - fixedSum - extraSum);

            getEl('totalIncDisp').innerText = `${netIncome}‚Ç¨`;
            getEl('incInput').value = db.income;

            // Updates Pcts Logic
            const pGrid = getEl('pctInputs');
            if (pGrid) {
                pGrid.innerHTML = Object.entries(db.fin_config.pcts).map(([k, v]) => `
                    <div style="flex:1;">
                        <span style="font-size:0.7rem; color:var(--text-dim); font-weight:700;">${k.toUpperCase()}</span>
                        <input type="number" value="${v}" onchange="window.updPct('${k}', this.value)" style="width:100%; padding:0.5rem; border-radius:10px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:var(--text); font-weight:700;">
                    </div>
                `).join('');
            }

            // Update Chart
            const ctx = document.getElementById('finChart')?.getContext('2d');
            if (ctx) {
                if (window.finChartInstance && typeof window.finChartInstance.destroy === 'function') {
                    window.finChartInstance.destroy();
                }
                const p = db.fin_config.pcts;
                window.finChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Gastos', 'Ahorro', 'Inv.', 'Ocio'],
                        datasets: [{
                            data: [p.spending, p.savings, p.invest, p.leisure],
                            backgroundColor: ['#448aff', '#00e676', '#ffc107', '#ff4081'],
                            borderWidth: 0,
                            cutout: '80%'
                        }]
                    },
                    options: { plugins: { legend: { display: false } }, responsive: true }
                });
            }

            // Details
            const items = [
                { l: 'Gastos Necesarios', p: `${db.fin_config.pcts.spending}%`, v: netIncome * (db.fin_config.pcts.spending / 100), c: '#448aff', icon: 'shopping-cart' },
                { l: 'Ahorro', p: `${db.fin_config.pcts.savings}%`, v: netIncome * (db.fin_config.pcts.savings / 100), c: '#00e676', icon: 'piggy-bank' },
                { l: 'Inversi√≥n', p: `${db.fin_config.pcts.invest}%`, v: netIncome * (db.fin_config.pcts.invest / 100), c: '#ffc107', icon: 'trending-up' },
                { l: 'Ocio', p: `${db.fin_config.pcts.leisure}%`, v: netIncome * (db.fin_config.pcts.leisure / 100), c: '#ff4081', icon: 'smile' }
            ];
            getEl('finDetails').innerHTML = items.map(it => `
                <div class="glass" style="padding:1rem; display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <div style="display:flex; gap:12px; align-items:center;">
                        <div style="background:${it.c}22; color:${it.c}; padding:8px; border-radius:10px;"><i data-lucide="${it.icon}" style="width:20px;"></i></div>
                        <div>
                            <p style="font-weight:700; font-size:0.9rem;">${it.l}</p>
                            <p style="font-size:0.7rem; color:var(--text-dim); font-weight:700;">${it.p}</p>
                        </div>
                    </div>
                    <h3 style="color:${it.c}">${Math.round(it.v)}‚Ç¨</h3>
                </div>
            `).join('');

            // Fixed & Extras with Sums
            getEl('fixedList').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3 style="margin:0;">Gastos Fijos</h3>
                    <span style="color:var(--text-dim); font-weight:800; font-size:0.9rem; background:rgba(255,255,255,0.05); padding:4px 12px; border-radius:15px;">Total: ${fixedSum}‚Ç¨</span>
                </div>
                ${db.fin_config.fixed.map((x, i) => `
                    <div style="display:grid; grid-template-columns: 1fr 60px 80px 40px; gap:8px; align-items:center; margin-bottom:0.5rem; background:rgba(255,255,255,0.03); padding:8px; border-radius:12px;">
                        <input value="${x.label}" onchange="window.updFinItem('fixed', ${i}, 'label', this.value)" placeholder="Nombre" style="background:none; border:none; color:var(--text); font-weight:700; width:100%;">
                        <input type="number" value="${x.amount}" onchange="window.updFinItem('fixed', ${i}, 'amount', this.value)" placeholder="‚Ç¨" style="background:none; border:none; color:var(--text); font-weight:700; width:100%;">
                        <input type="text" value="${x.expire || ''}" onchange="window.updFinItem('fixed', ${i}, 'expire', this.value)" placeholder="D√≠a/Exp" style="background:rgba(255,255,255,0.05); border:none; color:var(--text-dim); font-size:0.7rem; border-radius:4px; text-align:center; padding:4px;">
                        <button onclick="window.delFinItem('fixed', ${i})" style="background:none; border:none; color:#ff4d6d;"><i data-lucide="trash-2" style="width:16px;"></i></button>
                    </div>
                `).join('')}
                <button onclick="window.addFinItem('fixed')" style="width:100%; padding:0.6rem; border-radius:12px; background:rgba(255,255,255,0.05); border:2px dashed rgba(255,255,255,0.1); color:var(--text-dim); font-weight:700; margin-top:0.5rem;">+ Gasto Fijo</button>
            `;

            getEl('extrasList').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; margin-top:1.5rem;">
                    <h3 style="margin:0;">Pagos Extras (Bloc)</h3>
                    <span style="color:var(--text-dim); font-weight:800; font-size:0.9rem; background:rgba(255,255,255,0.05); padding:4px 12px; border-radius:15px;">Total: ${extraSum}‚Ç¨</span>
                </div>
                ${db.fin_config.extras.map((x, i) => `
                    <div style="display:grid; grid-template-columns: 1fr 60px 40px; gap:8px; align-items:center; margin-bottom:0.5rem; background:rgba(255,255,255,0.03); padding:8px; border-radius:12px;">
                        <input value="${x.label}" onchange="window.updFinItem('extras', ${i}, 'label', this.value)" placeholder="Concepto" style="background:none; border:none; color:var(--text); font-weight:700; width:100%;">
                        <input type="number" value="${x.amount}" onchange="window.updFinItem('extras', ${i}, 'amount', this.value)" placeholder="‚Ç¨" style="background:none; border:none; color:var(--text); font-weight:700; width:100%;">
                        <button onclick="window.delFinItem('extras', ${i})" style="background:none; border:none; color:#ff4d6d;"><i data-lucide="trash-2" style="width:16px;"></i></button>
                    </div>
                `).join('')}
                <button onclick="window.addFinItem('extras')" style="width:100%; padding:0.6rem; border-radius:12px; background:rgba(255,255,255,0.05); border:2px dashed rgba(255,255,255,0.1); color:var(--text-dim); font-weight:700; margin-top:0.5rem;">+ Pago Extra</button>
            `;

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.updPct = (k, v) => {
            db.fin_config.pcts[k] = Number(v) || 0;
            window.renderFin();
            window.saveFinConfig();
        }

        window.addFinItem = (type) => {
            db.fin_config[type].push({ label: '', amount: 0, expire: '' });
            window.renderFin();
            window.saveFinConfig();
        }

        window.updFinItem = (type, idx, field, val) => {
            db.fin_config[type][idx][field] = field === 'amount' ? Number(val) : val;
            window.renderFin();
            window.saveFinConfig();
        }

        window.delFinItem = (type, idx) => {
            db.fin_config[type].splice(idx, 1);
            window.renderFin();
            window.saveFinConfig();
        }

        window.saveFinConfig = async () => {
            db.income = Number(getEl('incInput').value) || 0;
            if (user) {
                const { error } = await supabase.from('profiles').upsert({
                    id: user.id,
                    income: db.income,
                    fin_config: db.fin_config
                }, { onConflict: 'id' });
                if (error) {
                    console.error("SaveFinConfig Error:", error);
                    toast("Error: " + (error.message || "al guardar finanzas"), "#ff4081");
                    return;
                }
            }
            toast("Guardado");
        }

        window.renderStats = () => {
            const cont = getEl('statsCont');
            const mLbl = getEl('statsMonthLabel');
            if (!cont || !mLbl) return;
            const m = currCal.getMonth(), y = currCal.getFullYear();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            mLbl.innerText = `${monthNames[m]} ${y}`;
            let tCnt = 0; const pref = `${y}-${String(m + 1).padStart(2, '0')}`;
            Object.keys(db.t_logs).forEach(d => { if (d.startsWith(pref) && db.t_logs[d]) tCnt++; });
            const hStats = db.habits.map(h => {
                let c = 0;
                Object.keys(db.logs).forEach(d => { if (d.startsWith(pref) && db.logs[d][h.id]) c++; });
                return { n: h.name, c };
            });
            cont.innerHTML = `<div class="glass" style="padding:1.5rem; display:flex; align-items:center; gap:1.5rem;"><div style="background:rgba(124, 77, 255, 0.1); color:var(--p); padding:1rem; border-radius:15px;"><i data-lucide="dumbbell" style="width:30px; height:30px;"></i></div><div><h2 style="margin:0; font-size:2rem;">${tCnt}</h2><p style="margin:0; color:var(--text-dim); font-weight:700; font-size:0.8rem;">Entrenos del mes</p></div></div>`;
            hStats.forEach(hs => {
                const total = new Date(y, m + 1, 0).getDate();
                const pct = total > 0 ? Math.round((hs.c / total) * 100) : 0;
                cont.innerHTML += `<div class="glass" style="padding:1.5rem;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;"><div><h3 style="margin:0;">${hs.n}</h3><p style="margin:0; color:var(--text-dim); font-size:0.7rem; font-weight:700;">${hs.c} d√≠as</p></div><h2 style="margin:0; color:var(--s);">${pct}%</h2></div><div style="height:6px; background:rgba(255,255,255,0.05); border-radius:10px; overflow:hidden;"><div style="height:100%; width:${pct}%; background:var(--s);"></div></div></div>`;
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- WRITES ---
        window.addHabit = async () => {
            if (!user) return alert("Error: Inicia sesi√≥n de nuevo");
            const name = prompt('Nombre del h√°bito:');
            if (!name) return;
            toast("Guardando...", "#448aff");
            try {
                const { data, error } = await supabase.from('habits').insert({ user_id: user.id, name }).select();
                if (error) throw error;
                if (data && data.length > 0) {
                    db.habits.push(data[0]);
                    window.renderHabits();
                    toast("¬°Hecho!");
                }
            } catch (e) {
                console.error("AddHabit Fail:", e);
                alert("Error Supabase: " + e.message);
            }
        }

        window.toggleHabit = async (id, done) => {
            if (!user) return;
            if (!db.logs[selDayStr]) db.logs[selDayStr] = {};
            db.logs[selDayStr][id] = !done;
            window.renderHabits(); window.renderCal();
            const { error } = await supabase.from('habit_logs').upsert({ user_id: user.id, habit_id: id, date: selDayStr, completed: !done }, { onConflict: 'habit_id, date' });
            if (error) {
                console.error("ToggleHabit Error:", error);
                toast("Error al guardar", "#ff4081");
            }
            await syncAll();
        }

        window.addBlock = async () => {
            if (!user) return alert("Error: Inicia sesi√≥n de nuevo");
            const n = prompt('Nombre de la rutina:');
            if (!n) return;
            toast("Creando...", "#448aff");
            try {
                const { data, error } = await supabase.from('training_blocks').insert({ user_id: user.id, name: n, exercises: [] }).select();
                if (error) throw error;
                if (data && data.length > 0) {
                    db.blocks.push(data[0]);
                    window.showBlocks();
                    toast("¬°Hecho!");
                }
            } catch (e) {
                console.error("AddBlock Fail:", e);
                alert("Error Supabase: " + e.message);
            }
        }

        window.updEx = async (i, f, v) => {
            const b = db.blocks.find(x => x.id === currBlockId); if (!b) return;
            b.exercises[i][f] = v;
            await supabase.from('training_blocks').update({ exercises: b.exercises }).eq('id', b.id);
            toast("Guardado");
        }

        window.addEx = async () => {
            const b = db.blocks.find(x => x.id === currBlockId); if (!b) return;
            if (!b.exercises) b.exercises = [];
            b.exercises.push({ n: '', w: '', s: '', r: '' });
            await supabase.from('training_blocks').update({ exercises: b.exercises }).eq('id', b.id);
            window.renderExs();
        }

        window.markDayTrained = async () => {
            if (!user) return;
            const done = !db.t_logs[selDayStr];
            db.t_logs[selDayStr] = done;
            window.updateBtnTrained(); window.renderCal();
            const { error } = await supabase.from('training_logs').upsert({ user_id: user.id, date: selDayStr, completed: done }, { onConflict: 'user_id, date' });
            if (error) {
                console.error("MarkDayTrained Error:", error);
                toast("Error al guardar", "#ff4081");
            }
            await syncAll();
        }

        window.setTab = (id, el) => {
            const target = getEl('view-' + id);
            if (!target) return;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
            target.classList.remove('hidden');
            if (el) el.classList.add('active');
            window.renderAll();
        }

        window.calShift = (v) => {
            currCal.setMonth(currCal.getMonth() + v);
            window.renderCal();
            if (!getEl('view-stats').classList.contains('hidden')) window.renderStats();
        }

        // --- INIT ---
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                user = session.user;
                getEl('auth-overlay').style.display = 'none';
                getEl('app-view').classList.remove('hidden');
                await syncAll();
            }

            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log("Auth event:", event);
                if (session) {
                    user = session.user;
                    getEl('auth-overlay').style.display = 'none';
                    getEl('app-view').classList.remove('hidden');
                } else {
                    user = null;
                    getEl('auth-overlay').style.display = 'flex';
                    getEl('app-view').classList.add('hidden');
                }
            });
        }

        init();
        setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 1000);
    </script>
</body>

</html>